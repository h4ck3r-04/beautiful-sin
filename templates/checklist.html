{% extends 'base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" type="text/css" href="{% static 'css/checklist.css' %}">
<style>
  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .notes-textarea {
    width: 100%;
    margin-top: 10px;
  }
  .download-btn {
    margin-top: 10px;
  }
  .download-btn i {
    margin-right: 5px;
  }
</style>
{% endblock %}

{% block content %}
  <h1>CheckList</h1>
  <ul class="nav nav-tabs">
    {% for tab in tabs %}
      <li class="{% if forloop.first %}active{% endif %}"><a data-toggle="tab" href="#{{ tab.id }}">{{ tab.title }}</a></li>
    {% endfor %}
  </ul>
  <div class="tab-content">
    {% for tab in tabs %}
      <div id="{{ tab.id }}" class="tab-pane fade {% if forloop.first %}in active{% endif %}">
        <div class="header-row">
          <h3>{{ tab.title }}</h3>
          <button class="btn btn-primary download-btn" data-tab-id="{{ tab.id }}"><i class="ti ti-download"></i>Download Progress</button>
        </div>
        <p>{{ tab.content }}</p>
        <textarea class="notes-textarea" placeholder="Enter your notes here..."></textarea>
      </div>
    {% endfor %}
  </div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/checklist.js' %}"></script>
<script>
  document.querySelectorAll('.download-btn').forEach(function(button) {
    button.addEventListener('click', function() {
      let tabId = this.getAttribute('data-tab-id');
      let tab = document.getElementById(tabId);
      let title = tab.querySelector('h3').innerText;
      let content = tab.querySelector('p').innerText;
      let notes = tab.querySelector('.notes-textarea').value;

      let checklistData = {title: title, content: content, notes: notes};
      let json = JSON.stringify(checklistData, null, 2);
      let blob = new Blob([json], {type: "application/json"});
      let url = URL.createObjectURL(blob);

      let a = document.createElement('a');
      a.href = url;
      a.download = title.replace(/\s+/g, '_') + '_progress.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  });
</script>
{% endblock %}
